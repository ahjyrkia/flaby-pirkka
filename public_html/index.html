<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">

        <title>PirkkaJS</title>

        <script src = "sprite.js" ></script>
        <script src="howler.js"></script>
        <script src = "jquery.js" ></script>
        <script src="jquery-mobile.js"></script>
        <script src="taphold.js"></script>

        <style>
            canvas {
                display: block;
                position: absolute;
                margin: auto;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
            }
        </style>
    </head>
    <body>

        <a>last update: </a><a id="date"></a>

        <script>
            var d = new Date();
            document.getElementById("date").innerHTML = new Date().toJSON().slice(0, 10);
        </script>
        <script>
            var
                    keyUp, keyLeft, keyDown, keyRight, keyA, keyEnter, keyS,
                    keyD,
                    canvas,
                    ctx,
                    width,
                    height,
                    fgpos = 0,
                    frames = 0,
                    score = 0,
                    best = 0,
                    bullethitSound = new Howl({
                        urls: ["res/bulletHit.mp3"]
                    }),
                    fieldSound = new Howl({
                        urls: ["res/forcefield.mp3"]
                    }),
                    electricSound = new Howl({
                        urls: ["res/electriccurrent.mp3"]
                    }),
                    gunSound = new Howl({
                        urls: ["res/gun.mp3"]
                    }),
                    explosionSound = new Howl({
                        urls: ["res/explosion.mp3"]
                    }),
                    audio = {
                        beers: [new Audio("res/bisse.mp3"),
                            new Audio("res/bisse3.mp3"),
                            new Audio("res/wingflap.mp3"),
                            new Audio("res/bisseCrush.mp3")],
                        sounds: [new Audio("res/music.mp3")]
                    },
            currentstate,
                    states = {
                        Splash: 0, Game: 1, Score: 2
                    },
            okbtn,
                    hero = {
                        h_x: 28,
                        h_y: 0,
                        frame: 0,
                        animation: [0, 1, 2, 1],
                        shieldAnimation: [0, 0, 1, 1, 2, 2, 3, 3],
                        repelAnimation: [0, 1, 2, 3, 4, 5, 6, 7],
                        repelFrame: 0,
                        rotation: 0,
                        radius: 12,
                        shieldFrame: 0,
                        shieldEnergy: 100,
                        shieldReload: 100,
                        momentum: 2,
                        bulletRotation: 10,
                        bulletEnergyCost: 15,
                        bulletReload: 0,
                        hp: 500,
                        maxHp: 500,
                        reloadRepel: 300,
                        reset: function () {
                            hero.hp = hero.maxHp;
                            hero.reloadRepel = 300;
                            hero.shieldEnergy = hero.shieldReload;
                        },
                        update: function () {
                            var n = currentstate === states.Splash ? 10 : 5;
                            this.frame += frames % n === 0 ? 1 : 0;
                            this.frame %= this.animation.length;
                            if (currentstate === states.Score) {

                            } else if (currentstate === states.Splash) {
                                this.h_x = 40;
                                this.h_y = height - 280 + 5 * Math.cos(frames / 10);
                                hero.rotation = 0;
                            } else {
                                hitDetection();
                                if (hero.hp < 500) {
                                    hero.hp++;
                                }
                                if (this.h_y >= height - s_fg.height - 27) {
                                    this.h_y = height - s_fg.height - 30;
                                    if (currentstate === states.Game) {
                                        hero.hp = -1;
                                        explosions.heroboom(hero.h_x, hero.h_y);
                                    }
                                }

                                if (keyA && hero.bulletReload >= hero.bulletRotation && hero.bulletEnergyCost < hero.hp) {
                                    gunSound.play();
                                    projectiles.shoot();
                                    hero.hp -= hero.bulletEnergyCost;
                                    hero.bulletReload = 0;
                                } else {
                                    hero.bulletReload++;
                                }
                                if (keyUp) {
                                    hero.h_y -= hero.momentum;
                                }
                                if (keyLeft) {
                                    hero.h_x -= hero.momentum;
                                }
                                if (keyDown) {
                                    hero.h_y += hero.momentum;
                                }
                                if (keyRight) {
                                    hero.h_x += hero.momentum;
                                }
                                if (keyD && hero.reloadRepel >= 300) {
                                    projectiles.repel();
                                    hero.reloadRepel = 0;
                                    hero.repelFrame++;
                                } else {
                                    if (hero.reloadRepel < 300) {
                                        hero.reloadRepel++;
                                    }
                                    if (hero.repelFrame > 0 && hero.repelFrame < 7) {
                                        hero.repelFrame++;
                                    } else {
                                        hero.repelFrame = 0;
                                    }
                                }
                                if (keyS && hero.shieldEnergy > 0) {
                                    if (hero.shieldFrame < 7) {
                                        hero.shieldFrame++;
                                    }
                                    electricSound.play();
                                    
                                } else {
                                    if (hero.shieldFrame > 0) {
                                        hero.shieldFrame--;
                                    }
                                }
                                if (!keyS && hero.shieldEnergy < 100) {
                                    hero.shieldEnergy++;
                                }
                            }
                            
                        }
                        ,
                        draw: function (ctx) {
                            var n = this.animation[this.frame];
                            var n2 = this.shieldAnimation[this.shieldFrame];
                            var n3 = this.repelAnimation[this.repelFrame];
                            if (currentstate !== states.Score) {
                                s_bird[n].draw(ctx, this.h_x, this.h_y);
                                if ((keyS || hero.shieldFrame > 0) && hero.shieldEnergy > 2) {
                                    s_forcefield[n2].draw(ctx, this.h_x - 4, this.h_y - 4);
                                }
                                if (hero.reloadRepel < 300) {
                                    s_repel[n3].draw(ctx, hero.h_x - 73, hero.h_y - 73);
                                }
                            }
                        }
                    },
            explosions = {
                _explosions: [],
                animation: [0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5],
                reset: function () {
                    this._explosions = [];
                },
                enemyhit: function (x, y) {
                    this._explosions.push({
                        e_x: x, 
                        e_y: y,
                        type: 1,
                        frame: 0 
                    });
                },
                boom: function (boomx, boomy) {
                    this._explosions.push({
                        e_x: boomx,
                        e_y: boomy,
                        type: 0,
                        frame: 0,
                        animation: [0, 0, 1, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7]
                    });
                },
                heroboom: function (boomx, boomy) {
                    this._explosions.push({
                        e_x: boomx,
                        e_y: boomy,
                        type: -1,
                        frame: 0
                    });
                },
                update: function () {
                    for (var i = 0, max = this._explosions.length; i < max; i++) {
                        var explosion = this._explosions[i];
                        if (explosion.frame < 11) {
                            explosion.frame++;
                        } else {
                            if (explosion.type === -1) {
                                explosionSound.play();
                                if (hero.hp < 1) {
                                    hero.hp = 0;
                                    currentstate = states.Score;
                                }
                            }
                            this._explosions.splice(i, 1);
                            i--;
                            max--;
                        }

                    }
                },
                draw: function (ctx) {
                    for (var i = 0, max = this._explosions.length; i < max; i++) {
                        var explosion = this._explosions[i];
                        var n = this.animation[explosion.frame];
                        if (explosion.type === 1) {
                            s_explosion2[n].draw(ctx, explosion.e_x, explosion.e_y);
                        } else {
                            s_explosion_cfree[n].draw(ctx, explosion.e_x-10, explosion.e_y-10);
                        }
                    }

                    ctx.font = "10px Comic Sans MS";
                    ctx.strokeStyle = "#228B22";
                    if (hero.hp >= 0) {
                        if (hero.hp < 0.66 * hero.maxHp) {
                            ctx.strokeStyle = "#FF8C00";
                        }
                        if (hero.hp < 0.33 * hero.maxHp) {
                            ctx.strokeStyle = "#A52A2A";
                        }

                        if (currentstate !== states.Score && hero.hp < hero.maxHp) {
                            ctx.strokeText(hero.hp, hero.h_x - 10, hero.h_y + 8);

                        }
                    }
                    if (hero.reloadRepel < 300) {
                        ctx.strokeStyle = "#FFD700";
                        ctx.strokeText(hero.reloadRepel, hero.h_x - 10, hero.h_y + 18);
                    }
                    if (hero.shieldEnergy < 100) {
                        ctx.strokeStyle = "#1E90FF";
                        ctx.strokeText(hero.shieldEnergy, hero.h_x - 10, hero.h_y + 28);
                    }
                    ctx.strokeStyle = "black";

                }
            },
            enemies = {
                _enemies: [],
                reset: function () {
                    this._enemies = [];
                },
                update: function () {
                    if (frames % 50 === 0 && ((frames > 100 && frames < 1400) || (frames > 2800 && frames < 3700))) {
                        this._enemies.push({
                            e_x: 550,
                            e_y: (330 * Math.random()),
                            radius: 12,
                            type: 1,
                            animation: [0, 0, 1, 1, 2, 2, 3, 3],
                            frame: 0,
                            hp: 2,
                            speed: 1,
                            bounce: 0.2,
                            damage: 100
                        });
                    }
                    if (frames > 700 && frames % 100 === 0 && frames < 1400) {
                        this._enemies.push({
                            e_x: 550,
                            e_y: (330 * Math.random()),
                            radius: 17,
                            type: 2,
                            animation: [0, 0, 1, 1],
                            frame: 0,
                            hp: 5,
                            speed: 0.5,
                            shootRotation: 80,
                            reloadTime: 80,
                            bounce: 0.5,
                            damage: 150
                        });
                    }

                    if (frames > 1300 && frames % 400 === 0 && frames <= 3200) {
                        var y = 0;
                        var enemyType = 2;
                        var enemyHp = 5;
                        if (frames === 1600) {
                            y = -45;
                        }
                        if (frames === 2000) {
                            y = 140;
                        }
                        if (frames === 2400) {
                            y = 55;
                            enemyType = 2.5;
                            enemyHp = 10;
                        }
                        if (frames === 2800) {
                            y = -45;
                        }
                        if (frames === 3200) {
                            y = 140;
                        }
                        for (var i = 0, max = 5; i < max; i++) {
                            y += 36;
                            if (i === 0 || i === 4) {
                                enemyType = 2.5;
                                enemyHp = 20;
                            }
                            this._enemies.push({
                                e_x: 550,
                                e_y: y,
                                radius: 17,
                                type: enemyType,
                                animation: [0, 0, 1, 1],
                                frame: 0,
                                hp: enemyHp,
                                speed: 0.5,
                                shootRotation: 260,
                                reloadTime: 80,
                                bounce: 0.5,
                                damage: 150
                            });
                        }
                    }
                    if (frames % 50 === 0 && frames > 3800 && frames < 5500) {
                        var addy = 0;
                        var addx = 0;
                        for (var i = 0, max = 40; i < max; i++) {
                            addx = (50 * Math.random());
                            if (frames < 4200) {
                                if (i < 30) {
                                    addy = (180 * Math.random());
                                } else {
                                    addy = 250 + (90 * Math.random());
                                }
                            }
                            if (frames >= 4200 && frames < 4600) {
                                if (i < 25) {
                                    addy = (120 * Math.random());
                                } else {
                                    addy = 190 + (130 * Math.random());
                                }
                            }
                            if (frames >= 4600 && frames < 4900) {
                                if (i < 15) {
                                    addy = (80 * Math.random());
                                } else {
                                    addy = 140 + (190 * Math.random());
                                }
                            }
                            if (frames >= 4900 && frames < 5300) {
                                if (i < 25) {
                                    addy = (200 * Math.random());
                                } else {
                                    addy = 270 + (60 * Math.random());
                                }
                            }
                            if (frames >= 5300) {
                                if (i < 30) {
                                    addy = (180 * Math.random());
                                } else {
                                    addy = 250 + (90 * Math.random());
                                }
                            }

                            this._enemies.push({
                                e_x: 550 + addx,
                                e_y: addy,
                                radius: 12,
                                type: 1,
                                animation: [0, 0, 1, 1, 2, 2, 3, 3],
                                frame: 0,
                                hp: 2,
                                speed: 1,
                                bounce: 0.2,
                                damage: 100
                            });
                        }
                    }
                    if (frames > 4149 && frames < 5051) {
                        var addy = -1;
                        if (frames === 4150) {
                            addy = 210;
                        }
                        if (frames === 4550) {
                            addy = 165;
                        }
                        if (frames === 4750) {
                            addy = 105;
                        }
                        if (frames === 5050) {
                            addy = 220;
                        }

                        if (addy >= 0) {
                            this._enemies.push({
                                e_x: 550,
                                e_y: addy,
                                radius: 17,
                                type: 2,
                                animation: [0, 0, 1, 1],
                                frame: 0,
                                hp: 5,
                                speed: 1,
                                shootRotation: 80,
                                reloadTime: 80,
                                bounce: 0.5,
                                damage: 150
                            });
                        }
                    }

                    if (frames === 5450) {
                        this._enemies.push({
                            e_x: 550,
                            e_y: 213,
                            radius: 17,
                            type: 2.5,
                            animation: [0, 0, 1, 1],
                            frame: 0,
                            hp: 20,
                            speed: 1,
                            shootRotation: 80,
                            reloadTime: 80,
                            bounce: 0.5,
                            damage: 150
                        });
                    }
                    if (frames === 5950) {
                        this._enemies.push({// goku
                            e_x: 540,
                            e_y: 170,
                            radius: 25,
                            type: 10,
                            flyAnimation: [0, 1, 1, 2, 2, 3, 3],
                            flyFrame: 0,
                            shootFrame: 0,
                            frame: 0,
                            hp: 200,
                            speed: 2,
                            yspeedDown: 2,
                            yspeedUp: -2,
                            yMoveTo: 170,
                            shootRotation: 80,
                            reloadTime: 20,
                            bounce: 0,
                            damage: 450,
                            kame: 0,
                            kameLoad: 500,
                            rain: 0,
                            rainLoad: 300,
                            kiBomb: 0,
                            kiBombLoad: 300,
                            kiBombVelocity: 0.1
                        });
                    }
//                 
                    for (var i = 0, max = this._enemies.length; i < max; i++) {
                        var enemy = this._enemies[i];
                        enemy.e_y = enemy.e_y + enemy.bounce * Math.cos(frames / 10);
                        enemy.e_x -= enemy.speed;
                        if (enemy.type === 2 || enemy.type === 2.5) {
                            if (enemy.shootRotation < 0) {
                                projectiles.enemyshoot(enemy.e_x, enemy.e_y, 10, 2, 0.1, 85);
                                enemy.shootRotation = enemy.reloadTime;
                            } else {
                                enemy.shootRotation--;
                            }
                        }
                        if (enemy.type === 10) {
                            if (enemy.e_y > enemy.yMoveTo) {
                                enemy.e_y += enemy.yspeedUp;
                                enemy.shootRotation = 10;
                                if (enemy.flyFrame < 6) {
                                    enemy.flyFrame++;
                                }
                            }
                            if (enemy.e_y < enemy.yMoveTo) {
                                enemy.e_y += enemy.yspeedDown;
                                enemy.shootRotation = 10;
                                if (enemy.flyFrame < 6) {
                                    enemy.flyFrame++;
                                }
                            }
                            var erotus = Math.abs(enemy.e_y - enemy.yMoveTo);
                            if (enemy.e_y === enemy.yMoveTo || erotus < 2) {
                                enemy.e_y = enemy.yMoveTo;
                                if (enemy.flyFrame > 0) {
                                    enemy.flyFrame--;
                                }

                            }
                            if (enemy.hp < 175 && enemy.hp > 170 || enemy.hp < 140 && enemy.hp > 135) {
                                enemy.kame = 1;
                            }
                            if (enemy.kame) {
                                enemy.kameLoad--;
                            }
                            if (enemy.hp < 103 && enemy.hp > 93 || enemy.hp < 73 && enemy.hp > 63) {
                                enemy.rain = 1;
                            }
                            if (enemy.rain) {
                                enemy.rainLoad--;
                            }
                            if (enemy.hp < 40 && enemy.hp > 35 || enemy.hp < 20 && enemy.hp > 15) {
                                enemy.kiBomb = 1;
                            }
                            if (enemy.kiBomb) {
                                enemy.kiBombLoad--;
                            }

                        }
                        if (enemy.e_x === -50) {
                            this._enemies.splice(i, 1);
                            max--;
                            i--;
                        }
                    }
                },
                draw: function (ctx) {
                    for (var i = 0, max = this._enemies.length; i < max; i++) {
                        var enemy = this._enemies[i];
                        if (enemy.type === 1) {
                            var n = enemy.animation[enemy.frame];
                            s_enemy[n].draw(ctx, enemy.e_x, enemy.e_y);
                            if (enemy.frame === 7) {
                                enemy.frame = 0;
                            } else {
                                enemy.frame++;
                            }
                        }
                        if (enemy.type === 2 || enemy.type === 2.5) {
                            var n = enemy.animation[enemy.frame];
                            if (enemy.type === 2.5) {
                                s_forcefield[3].draw(ctx, enemy.e_x - 2, enemy.e_y + 2);
                            }
                            s_enemy2[n].draw(ctx, enemy.e_x, enemy.e_y);
                            if (enemy.frame === 3) {
                                enemy.frame = 0;
                            } else {
                                enemy.frame++;
                            }
                        }
                        if (enemy.type === 10) {
                            var n = enemy.flyAnimation[enemy.flyFrame];
                            if (enemy.e_x < 440) {
                                enemy.speed = 0;
                            }
                            var movement = enemy.e_y;
                            var whichMovement = Math.random();
                            if (frames % 200 === 0 && enemy.kame === 0) {
                                if (whichMovement < 0.5) {
                                    while (true) {
                                        movement = Math.round((320 * Math.random()));
                                        var erotus = Math.abs(movement - enemy.e_y);
                                        if (erotus > 15) {
                                            break;
                                        }
                                    }
                                    enemy.yMoveTo = movement;
                                }
                                if (whichMovement > 0.5) {
                                    enemy.yMoveTo = hero.h_y;
                                }
                            }
                            if (hero.h_x > 350) {
                                enemy.yMoveTo = hero.h_y;
                            }
                            if (enemy.kame === 1 && enemy.kameLoad > 80) {
                                enemy.yMoveTo = hero.h_y;
                            }
                            if (enemy.rain === 1) {
                                enemy.yMoveTo = enemy.e_y;
                            }
                            if (enemy.kiBomb === 1) {
                                enemy.yMoveTo = enemy.e_y;
                            }
                            if (enemy.shootRotation < 1 && enemy.kame === 0 && enemy.rain === 0 && enemy.kiBomb === 0) {
                                enemy.shootFrame = 1;
                                projectiles.enemyshoot(enemy.e_x - 12, enemy.e_y - 15, 10, 4, 10, 175);
                                enemy.shootRotation = enemy.reloadTime;
                            } else {
                                enemy.shootRotation--;
                            }

                            if (enemy.flyFrame >= 0 && (enemy.yMoveTo !== enemy.e_y) && enemy.kameLoad === 80) {
                                s_goku_fly[n].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                            } else if (enemy.shootFrame > 0) {
                                s_goku_shoot[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                enemy.shootFrame++;
                                if (enemy.shootFrame > 8) {
                                    enemy.shootFrame = 0;
                                }
                            } else if (enemy.kameLoad < 500) {
                                var kameload = enemy.kameLoad;
                                if (kameload > 80) {
                                    s_goku_kame[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (kameload < 420 && kameload > 300) {
                                    s_goku_kameball[0].draw(ctx, enemy.e_x + 42, enemy.e_y + 18);
                                }
                                if (kameload <= 300 && kameload >= 80) {
                                    s_goku_kameball[1].draw(ctx, enemy.e_x + 38, enemy.e_y + 14);
                                }
                                if (kameload === 80) {
                                    projectiles.enemyshoot(enemy.e_x - 80, enemy.e_y - 29, 14, 5, 10, 450);
                                }
                                if (kameload <= 80 && kameload >= 50) {
                                    s_goku_kame[1].draw(ctx, enemy.e_x - 5, enemy.e_y - 15);
                                    s_goku_kameshot[0].draw(ctx, enemy.e_x - 55, enemy.e_y - 13);

                                }
                                if (kameload < 50 && kameload >= 0) {
                                    s_goku_kame[1].draw(ctx, enemy.e_x - 5, enemy.e_y - 15);
                                }

                                if (kameload < 0) {
                                    enemy.kame = 0;
                                    enemy.kameLoad = 500;
                                }
                            } else if (enemy.rainLoad < 300) {
                                if (enemy.rainLoad > 250) {
                                    s_goku_fly[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.rainLoad <= 250 && enemy.rainLoad > 230) {
                                    s_goku_fly[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.rainLoad <= 230 && enemy.rainLoad > 210) {
                                    s_goku_shoot[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.rainLoad <= 210 && enemy.rainLoad > 30) {
                                    s_goku_ki_load.draw(ctx, enemy.e_x + 10, enemy.e_y - 30);
                                }
                                if (enemy.rainLoad <= 30 && enemy.rainLoad > 15) {
                                    s_goku_shoot[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.rainLoad <= 15 && enemy.rainLoad > -15) {
                                    s_goku_shoot[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.rainLoad === 0) {
                                    var randomx = 0;
                                    var randomy = 0;
                                    for (var i = 0, max = 50; i < max; i++) {
                                        randomx = 500 + (300 * Math.random());
                                        randomy = (330 * Math.random());
                                        projectiles.enemyshoot(randomx, randomy, 10, 4, 0, 75);
                                    }
                                }
                                if (enemy.rainLoad <= -15) {
                                    enemy.rain = 0;
                                    enemy.rainLoad = 300;
                                }
                            } else if (enemy.kiBombLoad < 300) {
                                if (enemy.kiBombLoad > 250) {
                                    s_goku_fly[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.kiBombLoad <= 250 && enemy.kiBombLoad > 230) {
                                    s_goku_fly[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.kiBombLoad <= 230 && enemy.kiBombLoad > 210) {
                                    s_goku_shoot[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.kiBombLoad <= 210 && enemy.kiBombLoad > -100) {
                                    if (enemy.kiBombLoad < 180 && enemy.kiBombLoad > 150) {
                                        s_goku_kiBomb[0].draw(ctx, enemy.e_x + 20, enemy.e_y - 65);
                                    }
                                    if (enemy.kiBombLoad <= 150 && enemy.kiBombLoad > 120) {
                                        s_goku_kiBomb[1].draw(ctx, enemy.e_x + 17, enemy.e_y - 67);
                                    }
                                    if (enemy.kiBombLoad <= 120 && enemy.kiBombLoad > 90) {
                                        s_goku_kiBomb[2].draw(ctx, enemy.e_x + 14, enemy.e_y - 71);
                                    }
                                    if (enemy.kiBombLoad <= 90 && enemy.kiBombLoad > 60) {
                                        s_goku_kiBomb[3].draw(ctx, enemy.e_x, enemy.e_y - 90);

                                    }
                                    if (enemy.kiBombLoad <= 60 && enemy.kiBombLoad > -100) {
                                        s_goku_kiBomb[3].draw(ctx, enemy.e_x, (enemy.e_y - 90) - enemy.kiBombVelocity);
                                        enemy.kiBombVelocity *= 1.1;

                                    }

                                    s_goku_ki_load.draw(ctx, enemy.e_x + 10, enemy.e_y - 30);
                                }
                                if (enemy.kiBombLoad <= -100 && enemy.kiBombLoad > -115) {
                                    s_goku_shoot[0].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.kiBombLoad <= -115 && enemy.kiBombLoad > -130) {
                                    s_goku_shoot[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                }
                                if (enemy.kiBombLoad === -110) {
                                    projectiles.enemyshoot(hero.h_x + 520, hero.h_y - 550, 30, 6, 0, 1000);

                                }
                                if (enemy.kiBombLoad <= -130) {
                                    s_goku_shoot[1].draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                                    enemy.kiBomb = 0;
                                    enemy.kiBombLoad = 300;
                                    enemy.kiBombVelocity = 0.1;
                                }
                            } else {
                                s_goku_idle.draw(ctx, enemy.e_x + 2, enemy.e_y - 15);
                            }
                            ctx.strokeStyle = "#FFD700";
                            ctx.strokeText(enemy.hp, enemy.e_x + 40, enemy.e_y);
                        }

//                        ctx.beginPath();
//                        ctx.arc(enemy.e_x + 12, enemy.e_y + 12, enemy.radius, 0, 2 * Math.PI);
//                        ctx.stroke();


                    }
                }
            },
            projectiles = {
                _projectiles: [],
                reset: function () {
                    this._projectiles = [];
                },
                shoot: function () {
                    this._projectiles.push({
                        p_y: hero.h_y + 4,
                        p_x: hero.h_x + 6,
                        animation: [0, 0, 1, 1, 2, 2, 3, 3, 3, 3, 4],
                        frame: 0,
                        radius: 12,
                        type: 1,
                        velocity: 2,
                        damage: 1
                    });
                },
                repel: function () {
                    this._projectiles.push({
                        r_y: hero.h_y,
                        r_x: hero.h_x,
                        animation: [0, 0, 1, 1, 2, 2, 3, 3, 3, 3, 4],
                        frame: 0,
                        radius: 12,
                        type: 3,
                        velocity: 0,
                        damage: 5
                    });
                },
                enemyshoot: function (x, y, radius, type, velocity, damage) {
                    this._projectiles.push({
                        p_y: y + 22,
                        p_x: x - 6,
                        animation: [0, 0, 1, 1, 2, 2, 3, 3, 3, 3, 4],
                        frame: 0,
                        radius: radius,
                        type: type,
                        velocity: velocity,
                        damage: damage
                    });
                },
                update: function () {
                    if (this._projectiles.length !== 0) {
                        for (var i = 0, max = this._projectiles.length; i < max; i++) {

                            var projectile = this._projectiles[i];
                            if (projectile.type === 1) {
                                projectile.p_x = projectile.p_x + projectile.velocity;
                                projectile.velocity += 0.05;
                            }
                            if (projectile.type === 2 || projectile.type === 4 || projectile.type === 5) {
                                projectile.p_x = projectile.p_x - projectile.velocity;
                                projectile.velocity += 0.05;
                            }
                            if (projectile.type === 3) {
                                projectile.r_x = hero.h_x - projectile.radius + 8;
                                projectile.r_y = hero.h_y - projectile.radius + 8;
                                projectile.radius += 6;
                                if (projectile.radius > 90) {
                                    this._projectiles.splice(i, 1);
                                    i--;
                                    max--;
                                }
                            }
                            if (projectile.type === 6) {
                                projectile.p_x = projectile.p_x - projectile.velocity;
                                projectile.p_y = projectile.p_y + projectile.velocity;
                                projectile.velocity += 0.1;

                            }
                            if (projectile.frame < 10) {
                                projectile.frame++;
                            }
                            if (projectile.p_x > 520 || projectile.p_x < -20) {
                                if ((projectile.type === 4 || projectile.type === 6) && projectile.p_x > 500) {

                                } else {
                                    this._projectiles.splice(i, 1);
                                    i--;
                                    max--;
                                }
                            }

                        }
                    } // projectile movement and frame movement
                },
                draw: function (ctx) {
                    for (var i = 0, max = this._projectiles.length; i < max; i++) {
                        var projectile = this._projectiles[i];
                        var n = projectile.animation[projectile.frame];
                        if (projectile.type === 1) {
                            s_projectile[n].draw(ctx, projectile.p_x, projectile.p_y);
                        }
                        if (projectile.type === 2) {
                            s_projectile_enemy[n].draw(ctx, projectile.p_x, projectile.p_y);
                        }
                        if (projectile.type === 4) {
                            if (projectile.frame < 3) {
                                n = 1;
                            } else {
                                n = 0;
                            }
                            s_goku_projectile[n].draw(ctx, projectile.p_x, projectile.p_y);

                        }
                        if (projectile.type === 5) {
                            s_goku_kameprojectile.draw(ctx, projectile.p_x, projectile.p_y);
                            s_goku_kameshot[1].draw(ctx, projectile.p_x + 40, projectile.p_y);
                            s_goku_kameshot[1].draw(ctx, projectile.p_x + 54, projectile.p_y);
                            s_goku_kameshot[1].draw(ctx, projectile.p_x + 68, projectile.p_y);
                            s_goku_kameshot[1].draw(ctx, projectile.p_x + 84, projectile.p_y);
                        }
                        if (projectile.type === 6) {
                            s_goku_kiBomb[3].draw(ctx, projectile.p_x, projectile.p_y);

                        }

                    } // projectile draw
                }
            };
            function onpress(evt) {

                switch (currentstate) {
                    case states.Splash:
                        currentstate = states.Game;
                        frames = 0;
                        hero.reset();
                        break;
                    case states.Game:

                        break;
                    case states.Score:
                        var mousex = evt.offsetX, mousey = evt.offsetY;
                        if (okbtn.x < mousex && mousex < okbtn.x + okbtn.width &&
                                okbtn.y < mousey && mousey < okbtn.y + okbtn.height) {
                            projectiles.reset();
                            enemies.reset();
                            explosions.reset();
                            currentstate = states.Splash;

                            score = 0;
                        }
                        break;
                }

            }
            function hitDetection() {
                for (var i = 0, max = enemies._enemies.length; i < max; i++) {
                    var enemy = enemies._enemies[i];
                    var dx2 = (hero.h_x + hero.radius) - (enemy.e_x + enemy.radius);
                    var dy2 = (hero.h_y + hero.radius) - (enemy.e_y + enemy.radius);
                    var distance2 = Math.sqrt((dx2 * dx2) + (dy2 * dy2));
                    if (distance2 < hero.radius + enemy.radius) {
                        enemy.hp -= 3;
                        explosionSound.play();
                        audio.sounds[0].play();
                        explosions.boom(enemy.e_x, enemy.e_y);
                        if (enemy.hp <= 0) {
                            score++;
                            enemies._enemies.splice(i, 1);
                            i--;
                            max--;
                        }
                        if (hero.shieldFrame > 0) {
                            hero.shieldEnergy = hero.shieldEnergy - Math.round(enemy.damage / 2);
                            if (hero.shieldEnergy < 0) {
                                hero.hp -= Math.abs(hero.shieldEnergy) * 2;
                                hero.shieldEnergy = 0;
                            }
                        }
                        if (hero.shieldFrame === 0) {
                            hero.hp -= enemy.damage;
                            explosions.heroboom(hero.h_x, hero.h_y);
                        }
                    }
                    // Kivat toistot täällä. Pitää siivota joskus.
                    for (var j = 0, max2 = projectiles._projectiles.length; j < max2; j++) {
                        var projectile = projectiles._projectiles[j];
                        if (projectile.type === 1) {
                            var dx = (projectile.p_x + projectile.radius) - (enemy.e_x + enemy.radius);
                            var dy = (projectile.p_y + projectile.radius) - (enemy.e_y + enemy.radius);
                            var distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < projectile.radius + enemy.radius) {
                                bullethitSound.play();
                                enemy.hp = enemy.hp - projectile.damage;
                                explosions.enemyhit(projectile.p_x, projectile.p_y);
                                projectiles._projectiles.splice(j, 1);
                                j--;
                                max2--;

                                if (enemy.hp < 1) {
                                    explosions.boom(enemy.e_x, enemy.e_y);
                                    explosionSound.play();
                                    score++;
                                    audio.sounds[0].play();
                                    enemies._enemies.splice(i, 1);
                                    i--;
                                    max--;
                                }
                            }
                        }
                        if (projectile.type === 2 || projectile.type === 4 || projectile.type === 5 || projectile.type === 6) {
                            var dx = (projectile.p_x + projectile.radius) - (hero.h_x + hero.radius);
                            var dy = (projectile.p_y + projectile.radius) - (hero.h_y + hero.radius);
                            var distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < projectile.radius + hero.radius) {
                                bullethitSound.play();
                                if (projectile.type !== 6) {
                                    projectiles._projectiles.splice(j, 1);
                                }
                                explosions.enemyhit(projectile.p_x, projectile.p_y);
                                j--;
                                max2--;

                                if (hero.shieldFrame > 0) {
                                    hero.shieldEnergy = hero.shieldEnergy - Math.round(projectile.damage / 2);
                                    if (hero.shieldEnergy < 0) {
                                        hero.hp -= Math.abs(hero.shieldEnergy) * 2;
                                        hero.shieldEnergy = 0;
                                    }
                                }
                                if (hero.shieldFrame === 0) {
                                    hero.hp -= projectile.damage;
                                    if (hero.hp < 1) {
                                        explosions.heroboom(hero.h_x, hero.h_y);
                                    }
                                }
                            }
                        }
                        if (projectile.type === 3) {
                            var dx = (projectile.r_x + projectile.radius) - (enemy.e_x + enemy.radius);
                            var dy = (projectile.r_y + projectile.radius) - (enemy.e_y + enemy.radius);
                            var distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < projectile.radius + enemy.radius) {
                                enemy.hp = enemy.hp - projectile.damage;
                                explosions.enemyhit(enemy.e_x, enemy.e_y);


                                if (enemy.hp < 1) {
                                    explosions.boom(enemy.e_x, enemy.e_y);
                                    explosionSound.play();
                                    score++;
                                    audio.sounds[0].play();
                                    enemies._enemies.splice(i, 1);
                                    i--;
                                    max--;
                                }
                            }
                            for (var h = 0, max3 = projectiles._projectiles.length; h < max3; h++) {
                                var enemyProjectile = projectiles._projectiles[h];
                                if (enemyProjectile.type === 2 || enemyProjectile.type === 4 || enemyProjectile.type === 6) {
                                    var dx = (projectile.r_x + projectile.radius) - (enemyProjectile.p_x + enemyProjectile.radius);
                                    var dy = (projectile.r_y + projectile.radius) - (enemyProjectile.p_y + enemyProjectile.radius);
                                    var distance = Math.sqrt(dx * dx + dy * dy);
                                    if (distance < projectile.radius + enemyProjectile.radius) {
                                        explosions.boom(enemyProjectile.p_x, enemyProjectile.p_y)
                                        projectiles._projectiles.splice(h, 1);
                                        j--;
                                        max2--;
                                        h--;
                                        max3--;

                                    }
                                }
                            }
                        }
                    }
                }

            }

            function onKeyDown(event) {
                var keyCode = event.keyCode;
                switch (keyCode) {
                    case 39: //right
                        keyRight = true;
                        break;
                    case 40: //down
                        keyDown = true;
                        break;
                    case 37: //left
                        keyLeft = true;
                        break;
                    case 38: //up
                        keyUp = true;
                        break;
                    case 65: //a
                        keyA = true;
                        break;
                    case 13: //enter
                        keyEnter = true;
                        break;
                    case 83: //s
                        keyS = true;
                        break;
                    case 68: //d
                        keyD = true;
                        break;
                    case 77: //m
                        if (audio.sounds[0].volume > 0) {
                            audio.sounds[0].volume = 0.00;
                        } else {
                            audio.sounds[0].volume = 0.13;
                        }
                    case 78: //n
                        // mute äänet tänne
                        break;
                }
                if (currentstate === states.Score && keyEnter) {
                    projectiles.reset();
                    enemies.reset();
                    explosions.reset();
                    currentstate = states.Splash;

                    score = 0;
                }
                if (currentstate === states.Splash) {
                    if (keyA || keyRight || keyUp || keyLeft || keyDown) {
                        frames = 0;
                        hero.reset();
                        currentstate = states.Game;
                    }
                }
            }

            function onKeyUp(event) {
                var keyCode = event.keyCode;
                switch (keyCode) {

                    case 39: //right arrow
                        keyRight = false;
                        break;
                    case 40: //down arrow
                        keyDown = false;
                        break;
                    case 37: //left arrow
                        keyLeft = false;
                        break;
                    case 38: //up arrow
                        keyUp = false;
                        break;
                    case 65: //a
                        keyA = false;
                        break;
                    case 13: //enter
                        keyEnter = false;
                        break;
                    case 83: //s
                        keyS = false;
                        break;
                    case 68: //d
                        keyD = false;
                        break;
                }
            }

            function main() {
                canvas = document.createElement("canvas");
                width = window.innerHeight;
                height = window.innerHeight;
                var evt = "touchstart";
                if (width >= 500) {
                    width = 500;
                    height = 480;
                    canvas.style.border = "1px solid #000";
                    evt = "mousedown";
                }
                document.addEventListener(evt, onpress);
                // Block browser arrow keys from srollbar
                var arrow_keys_handler = function (e) {
                    switch (e.keyCode) {
                        case 37:
                        case 39:
                        case 38:
                        case 40: // Arrow keys
                        case 32:
                        case 9:
                            e.preventDefault();
                            break; // Space
                        default:
                            break; // do not block other keys
                    }
                };
                window.addEventListener("keydown", arrow_keys_handler, false);
                window.addEventListener("keydown", onKeyDown, false);
                window.addEventListener("keyup", onKeyUp, false);
                document.addEventListener();
                canvas.width = width;
                canvas.height = height;
                ctx = canvas.getContext("2d");
                currentstate = states.Splash;
                document.body.appendChild(canvas);
                var img = new Image();
                img.onload = function () {
                    initSprites(this);
                    ctx.fillStyle = s_bg.color;
                    okbtn = {
                        x: (width - s_buttons.Ok.width) / 2,
                        y: height - 200,
                        width: s_buttons.Ok.width,
                        height: s_buttons.Ok.height
                    };
                    audio.sounds[0].volume = 0.13;
                    bullethitSound.volume(0.1);
                    gunSound.volume(0.1);
                    electricSound.volume(0.007);
                    explosionSound.volume(0.20);
                    run();
                };
                img.src = "res/sheet.png";
            }
            function run() {
                var loop = function () {
                    update();
                    render();
                    ctx.font = "10px Comic Sans MS";
                    ctx.strokeText(frames, 10, 10);
                    window.requestAnimationFrame(loop, canvas);
                };
                window.requestAnimationFrame(loop, canvas);
            }
            function update() {
                frames++;
                if (currentstate !== states.Score) {
                    fgpos = (fgpos - 2) % 14;
                } else {
                    best = Math.max(best, score);
                }

                if (currentstate === states.Game) {
                    enemies.update();
                    projectiles.update();
                    explosions.update();
                    audio.sounds[0].play();
                }
                hero.update();
            }

            function render() {
                ctx.fillRect(0, 0, width, height);
                s_bg.draw(ctx, 0, height - s_bg.height);
                s_bg.draw(ctx, s_bg.width, height - s_bg.height);
                hero.draw(ctx);
                enemies.draw(ctx);
                projectiles.draw(ctx); //projectile draw
                explosions.draw(ctx);
                s_fg.draw(ctx, fgpos, height - s_fg.height);
                s_fg.draw(ctx, fgpos + s_fg.width, height - s_fg.height);
                s_fg.draw(ctx, fgpos + s_fg.width * 2, height - s_fg.height);
                ctx.font = "10px Comic Sans MS";

                ctx.strokeText("Movement: Arrow keys", 10, 400);
                ctx.strokeText("Shoot: A", 10, 410);
                ctx.strokeStyle = "#1E90FF";
                ctx.strokeText("Shield: S", 10, 420);
                ctx.strokeStyle = "#DAA520";
                ctx.strokeText("Repel: D", 10, 430);
                ctx.strokeStyle = "black";
                ctx.strokeText("Score screen skip: Enter", 10, 440);
                ctx.strokeText("Main screen: Any arrow key, shoot or mouse click to start game", 10, 450);
                ctx.strokeText("Mute/Unmute music: M", 10, 460);



                var width2 = width / 2;
                if (currentstate === states.Splash) {
                    s_splash.draw(ctx, width2 - s_splash.width / 2, height - 300);
                    s_text.GetReady.draw(ctx, width2 - s_text.GetReady.width / 2, height - 380);
                    s_flappypirkka.draw(ctx, width2 - s_text.GetReady.width / 2, height - 440);
                }



                if (currentstate === states.Score) {
                    ctx.fillRect(100, 100, 100, 100)
                    s_text.GameOver.draw(ctx, width2 - s_text.GameOver.width / 2, height - 400);
                    s_score.draw(ctx, width2 - s_score.width / 2, height - 340);
                    s_buttons.Ok.draw(ctx, okbtn.x, okbtn.y);
                    s_numberS.draw(ctx, width2 - 47, height - 304, score, null, 10);
                    s_numberS.draw(ctx, width2 - 47, height - 262, best, null, 10);
                } else {
                    s_numberB.draw(ctx, null, 20, score, width2);
                }
            }
            main();
        </script>
        <script>
            $(document).ready(function () {
                $(".ui-loader").hide();
            }
            );

        </script>
    </body>
</html>